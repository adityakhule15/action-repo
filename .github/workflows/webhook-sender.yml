name: Send Webhook on Repository Events

on:
  push:
    branches: ["*"]
  pull_request:
    types: [opened, closed]

jobs:
  send-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare webhook data
        id: prepare
        run: |
          # Default values
          EVENT_TYPE="push"
          FROM_BRANCH=""
          TO_BRANCH=""
          TIMESTAMP=""
          TITLE=""
          
          if [ "${{ github.event_name }}" = "push" ]; then
            EVENT_TYPE="push"
            FROM_BRANCH="${{ github.ref_name }}"
            TO_BRANCH="${{ github.ref_name }}"
            TIMESTAMP="${{ github.event.head_commit.timestamp }}"
            TITLE="${{ github.event.head_commit.message }}"
            
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "opened" ]; then
              EVENT_TYPE="pull_request"
            elif [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              EVENT_TYPE="merge"
            else
              echo "❌ Skipping - not a tracked PR event"
              exit 0
            fi
            
            FROM_BRANCH="${{ github.event.pull_request.head.ref }}"
            TO_BRANCH="${{ github.event.pull_request.base.ref }}"
            
            if [ "${{ github.event.action }}" = "opened" ]; then
              TIMESTAMP="${{ github.event.pull_request.created_at }}"
            else
              TIMESTAMP="${{ github.event.pull_request.merged_at }}"
            fi
            
            TITLE="${{ github.event.pull_request.title }}"
          fi
          
          # Set outputs
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "from_branch=$FROM_BRANCH" >> $GITHUB_OUTPUT
          echo "to_branch=$TO_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          
          echo "✅ Prepared: $EVENT_TYPE from $FROM_BRANCH to $TO_BRANCH"

      - name: Send Webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          # Test if URL is accessible
          echo "Testing connection to: $WEBHOOK_URL"
          curl -I -X GET "$WEBHOOK_URL" || true
          
          # Create payload
          PAYLOAD=$(jq -n \
            --arg event_type "${{ steps.prepare.outputs.event_type }}" \
            --arg author "${{ github.actor }}" \
            --arg from_branch "${{ steps.prepare.outputs.from_branch }}" \
            --arg to_branch "${{ steps.prepare.outputs.to_branch }}" \
            --arg timestamp "${{ steps.prepare.outputs.timestamp }}" \
            --arg repository "${{ github.repository }}" \
            --arg commit_id "${{ github.sha }}" \
            --arg title "${{ steps.prepare.outputs.title }}" \
            '{
              event_type: $event_type,
              author: $author,
              from_branch: $from_branch,
              to_branch: $to_branch,
              timestamp: $timestamp,
              repository: $repository,
              commit_id: $commit_id,
              title: $title
            }')
          
          echo "Sending payload:"
          echo "$PAYLOAD"
          
          # Send webhook
          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL"
          
          echo "✅ Webhook sent!"