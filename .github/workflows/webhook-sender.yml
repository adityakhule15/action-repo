name: GitHub Webhook Events

on:
  push:
    branches: ["*"]
  pull_request:
    types: [opened, closed]

jobs:
  send-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Send Webhook for Push, PR, or Merge
        run: |
          # YOUR RENDER APP URL
          WEBHOOK_URL="https://webhook-repo-aditya.onrender.com/webhook"
          
          echo "========================================"
          echo "GITHUB WEBHOOK SENDER"
          echo "========================================"
          
          # DETERMINE EXACT EVENT TYPE
          EVENT_TYPE="unknown"
          FROM_BRANCH=""
          TO_BRANCH=""
          TIMESTAMP=""
          TITLE=""
          
          # 1. PUSH EVENT
          if [ "${{ github.event_name }}" = "push" ]; then
            EVENT_TYPE="push"
            FROM_BRANCH="${{ github.ref_name }}"
            TO_BRANCH="${{ github.ref_name }}"
            TIMESTAMP="${{ github.event.head_commit.timestamp }}"
            TITLE="${{ github.event.head_commit.message }}"
            echo "üì§ Event: PUSH to $TO_BRANCH"
            
          # 2. PULL REQUEST OPENED EVENT
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "opened" ]; then
            EVENT_TYPE="pull_request"
            FROM_BRANCH="${{ github.event.pull_request.head.ref }}"
            TO_BRANCH="${{ github.event.pull_request.base.ref }}"
            TIMESTAMP="${{ github.event.pull_request.created_at }}"
            TITLE="${{ github.event.pull_request.title }}"
            echo "üì§ Event: PULL REQUEST from $FROM_BRANCH to $TO_BRANCH"
            
          # 3. MERGE EVENT (PR closed and merged)
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            EVENT_TYPE="merge"
            FROM_BRANCH="${{ github.event.pull_request.head.ref }}"
            TO_BRANCH="${{ github.event.pull_request.base.ref }}"
            TIMESTAMP="${{ github.event.pull_request.merged_at }}"
            TITLE="${{ github.event.pull_request.title }}"
            echo "üì§ Event: MERGE from $FROM_BRANCH to $TO_BRANCH"
            
          else
            echo "‚è≠Ô∏è Skipping: ${{ github.event_name }} / ${{ github.event.action }}"
            echo "Not Push, Pull Request, or Merge"
            exit 0
          fi
          
          # USE CURRENT TIME IF TIMESTAMP IS EMPTY
          if [ -z "$TIMESTAMP" ]; then
            TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          fi
          
          # CREATE PAYLOAD
          PAYLOAD=$(cat << EOF
          {
            "event_type": "$EVENT_TYPE",
            "author": "${{ github.actor }}",
            "from_branch": "$FROM_BRANCH",
            "to_branch": "$TO_BRANCH",
            "timestamp": "$TIMESTAMP",
            "repository": "${{ github.repository }}",
            "commit_id": "${{ github.sha }}",
            "title": "$TITLE",
            "action": "${{ github.event.action }}"
          }
          EOF
          )
          
          echo "üì¶ Payload:"
          echo "$PAYLOAD"
          echo ""
          
          # SEND WEBHOOK
          echo "üåê Sending to: $WEBHOOK_URL"
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL")
          
          echo "üì• HTTP Status: $RESPONSE"
          
          if [ -f "response.txt" ]; then
            echo "üì• Response:"
            cat response.txt
          fi
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ SUCCESS! Event sent to your dashboard"
            echo "üëâ Check: https://webhook-repo-aditya.onrender.com"
          else
            echo "‚ùå ERROR: Failed to send webhook"
            exit 1
          fi
          
          echo "========================================"